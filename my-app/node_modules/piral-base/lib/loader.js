"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getDefaultLoader = exports.createDefaultLoader = exports.extendLoader = void 0;
var tslib_1 = require("tslib");
var fetch_1 = require("./fetch");
var utils_1 = require("./utils");
var dependency_1 = require("./dependency");
var inBrowser = typeof document !== 'undefined';
var depContext = {};
function loadSharedDependencies(sharedDependencies) {
    if (sharedDependencies && typeof sharedDependencies === 'object') {
        var sharedDependencyNames = Object.keys(sharedDependencies);
        return Promise.all(sharedDependencyNames.map(function (name) {
            return depContext[name] || (depContext[name] = dependency_1.includeScriptDependency(sharedDependencies[name]));
        }));
    }
    return Promise.resolve();
}
function loadFrom(meta, getDependencies, loadPilet) {
    var dependencies = tslib_1.__assign({}, (getDependencies(meta) || {}));
    return loadSharedDependencies(meta.dependencies)
        .then(function () { return loadPilet(dependencies); })
        .then(function (app) { return (tslib_1.__assign(tslib_1.__assign({}, app), meta)); });
}
function extendLoader(fallback, specLoaders) {
    if (typeof specLoaders === 'object' && specLoaders) {
        return function (meta) {
            if (typeof meta.spec === 'string') {
                var loaderOverride = specLoaders[meta.spec];
                if (typeof loaderOverride === 'function') {
                    return loaderOverride(meta);
                }
            }
            return fallback(meta);
        };
    }
    return fallback;
}
exports.extendLoader = extendLoader;
function createDefaultLoader(dependencies, getDependencies, fetchDependency, config) {
    var getDeps = utils_1.getDependencyResolver(dependencies, getDependencies);
    return getDefaultLoader(getDeps, fetchDependency, config);
}
exports.createDefaultLoader = createDefaultLoader;
function getDefaultLoader(getDependencies, fetchDependency, config) {
    if (fetchDependency === void 0) { fetchDependency = fetch_1.defaultFetchDependency; }
    if (config === void 0) { config = {}; }
    return function (meta) {
        if (inBrowser && 'requireRef' in meta && meta.requireRef) {
            return loadFrom(meta, getDependencies, function (deps) { return dependency_1.includeDependency(meta, deps, config.crossOrigin); });
        }
        else if (inBrowser && 'bundle' in meta && meta.bundle) {
            return loadFrom(meta, getDependencies, function (deps) { return dependency_1.includeBundle(meta, deps, config.crossOrigin); });
        }
        var name = meta.name;
        if ('link' in meta && meta.link) {
            var link_1 = meta.link;
            return fetchDependency(link_1).then(function (content) {
                return loadFrom(meta, getDependencies, function (deps) { return dependency_1.compileDependency(name, content, link_1, deps); });
            });
        }
        else if ('content' in meta && meta.content) {
            var content_1 = meta.content;
            return loadFrom(meta, getDependencies, function (deps) { return dependency_1.compileDependency(name, content_1, undefined, deps); });
        }
        else {
            console.warn('Empty pilet found!', name);
        }
        return Promise.resolve(utils_1.createEmptyModule(meta));
    };
}
exports.getDefaultLoader = getDefaultLoader;
//# sourceMappingURL=loader.js.map