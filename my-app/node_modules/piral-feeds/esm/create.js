import { __assign, __spreadArray } from "tslib";
import * as actions from './actions';
import { buildName } from 'piral-core';
import { withFeed } from './withFeed';
import { createFeedOptions } from './utils';
/**
 * Creates new Pilet API extensions for supporting simplified data feed connections.
 */
export function createFeedsApi(config) {
    if (config === void 0) { config = {}; }
    return function (context) {
        context.defineActions(actions);
        context.dispatch(function (state) { return (__assign(__assign({}, state), { feeds: {} })); });
        return function (_, target) {
            var feeds = 0;
            return {
                createConnector: function (resolver) {
                    var id = buildName(target.name, feeds++);
                    var options = createFeedOptions(id, resolver);
                    var invalidate = function () {
                        var _a;
                        (_a = options.dispose) === null || _a === void 0 ? void 0 : _a.call(options);
                        context.createFeed(options.id);
                    };
                    if (options.immediately) {
                        context.loadFeed(options);
                    }
                    else {
                        invalidate();
                    }
                    var connect = (function (component) { return withFeed(component, options); });
                    Object.keys(options.reducers).forEach(function (type) {
                        var reducer = options.reducers[type];
                        if (typeof reducer === 'function') {
                            connect[type] = function () {
                                var args = [];
                                for (var _i = 0; _i < arguments.length; _i++) {
                                    args[_i] = arguments[_i];
                                }
                                context.updateFeed(id, args, function (data, item) { return reducer.call.apply(reducer, __spreadArray([connect, data], item)); });
                            };
                        }
                    });
                    connect.invalidate = invalidate;
                    return connect;
                },
            };
        };
    };
}
//# sourceMappingURL=create.js.map